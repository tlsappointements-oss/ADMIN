<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Mercedes-Benz GMAO | Admin Portal</title>
    <style>
        body { display: none; min-height: 100vh; background: #050505; color: #e0e0e0; margin: 0; font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: 280px; background: #000; border-right: 1px solid #333; padding: 30px 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        
        /* Directeur Styling */
        .director-panel { display: none; border: 1px solid #e30613; padding: 25px; margin-bottom: 30px; background: rgba(227, 6, 19, 0.05); position: relative; }
        .director-badge { position: absolute; top: -12px; left: 20px; background: #e30613; color: white; padding: 2px 10px; font-size: 0.6rem; font-weight: bold; }
        
        /* Table Styles */
        .gmao-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #111; font-size: 0.85rem; }
        .gmao-table th { text-align: left; color: #666; padding: 15px; border-bottom: 1px solid #333; text-transform: uppercase; font-size: 0.7rem; }
        .gmao-table td { padding: 15px; border-bottom: 1px solid #222; }
        
        .btn-mb { background: #e30613; color: white; border: none; padding: 10px 20px; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; transition: 0.3s; }
        .btn-mb:hover { background: white; color: black; }
        .status-pill { padding: 4px 8px; border-radius: 2px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="font-weight: 200; letter-spacing: 4px; color: #e30613;">MERCEDES-BENZ</h2>
        <p style="font-size: 0.6rem; color: #444; margin-bottom: 50px;">MAINTENANCE MANAGEMENT SYSTEM</p>
        
        <p id="userName" style="font-size: 0.8rem; margin-bottom: 5px; color: #fff;"></p>
        <p id="userRole" style="font-size: 0.65rem; color: #e30613; margin-bottom: 30px;"></p>
        
        <button class="btn-mb" style="background: transparent; border: 1px solid #333; text-align: left;" onclick="location.reload()">Asset Library</button>
        <button class="btn-mb" style="background: transparent; border: 1px solid #333; text-align: left; margin-top: 10px;">Interventions</button>
        
        <button onclick="logout()" style="margin-top: auto; background: none; border: none; color: #444; cursor: pointer; text-align: left;">SIGN OUT</button>
    </div>

    <div class="main-content">
        <div id="directorTools" class="director-panel">
            <div class="director-badge">DIRECTEUR PRIVILEGES</div>
            <h3 style="margin: 0 0 10px 0; font-weight: 300;">Global Database Synchronization</h3>
            <p style="font-size: 0.8rem; color: #888;">Upload the Excel CSV from <code>MAINTENANCE_DATABASE</code> to refresh all 105 machines.</p>
            
            <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
                <input type="file" id="csvFile" accept=".csv" style="font-size: 0.8rem; color: #666;">
                <button class="btn-mb" onclick="syncDatabase()">PUSH TO LIVE LIBRARY</button>
            </div>
        </div>

        <h2 id="viewTitle" style="font-weight: 200;">Plant Machine Library</h2>

        <div style="background: #111; padding: 20px; border: 1px solid #222;">
            <table class="gmao-table">
                <thead>
                    <tr id="tableHead">
                        </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './firebase.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, onSnapshot, doc, setDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const MOHAMED_EMAIL = "mohamed.aouladzerouali@jobson.com";

        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.replace("login.html"); return; }
            
            const email = user.email.toLowerCase();
            document.getElementById('userName').innerText = email.toUpperCase();
            document.body.style.display = "flex";

            if (email === MOHAMED_EMAIL) {
                initDirectorMode();
            } else {
                initTechnicianMode();
            }
        });

        function initDirectorMode() {
            document.getElementById('userRole').innerText = "DIRECTEUR D'USINE";
            document.getElementById('directorTools').style.display = "block";
            document.getElementById('viewTitle').innerText = "Directeur Approval Queue";
            
            document.getElementById('tableHead').innerHTML = `
                <th>Technician</th><th>Asset ID</th><th>Description</th><th>Time</th><th>Status</th><th>Action</th>
            `;

            onSnapshot(collection(db, "interventions"), (snap) => {
                const body = document.getElementById('tableBody');
                body.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    body.innerHTML += `
                        <tr>
                            <td>${data.technician}</td>
                            <td>${data.machineId}</td>
                            <td>${data.description}</td>
                            <td>${data.timestamp?.toDate().toLocaleString() || 'Recent'}</td>
                            <td><span class="status-pill" style="background:${data.approved ? '#00ff00' : '#ffcc00'}; color:#000">
                                ${data.approved ? 'VALIDATED' : 'PENDING'}</span></td>
                            <td>${!data.approved ? `<button class="btn-mb" style="padding:5px 10px; font-size:9px;" onclick="approveWork('${d.id}', '${data.machineId}')">APPROVE & RESTART</button>` : 'COMPLETED'}</td>
                        </tr>
                    `;
                });
            });
        }

        function initTechnicianMode() {
            document.getElementById('userRole').innerText = "MAINTENANCE TECHNICIAN";
            document.getElementById('tableHead').innerHTML = `
                <th>ID</th><th>Asset Name</th><th>Section</th><th>Condition</th><th>Status</th>
            `;

            onSnapshot(collection(db, "machines"), (snap) => {
                const body = document.getElementById('tableBody');
                body.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const color = m.status === "WORKING" ? "#00ff00" : "#e30613";
                    body.innerHTML += `
                        <tr>
                            <td><b>${m.machineId}</b></td>
                            <td>${m.name}</td>
                            <td>${m.section}</td>
                            <td>${m.description}</td>
                            <td><span style="color:${color}">‚óè ${m.status}</span></td>
                        </tr>
                    `;
                });
            });
        }

        // MOHAMED'S SYNC LOGIC
        window.syncDatabase = () => {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return alert("Select Mercedes_Plant_Assets.csv from your Desktop folder.");

            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split('\n').slice(1);
                for (let row of rows) {
                    const col = row.split(',');
                    if (col.length < 5) continue;
                    await setDoc(doc(db, "machines", col[0].trim()), {
                        machineId: col[0].trim(),
                        name: col[1].trim(),
                        section: col[2].trim(),
                        description: col[3].trim(),
                        status: col[4].trim()
                    });
                }
                alert("Directeur Update: 105 Machines Pushed to Live Database.");
            };
            reader.readAsText(file);
        };

        window.approveWork = async (id, mId) => {
            await updateDoc(doc(db, "interventions", id), { approved: true });
            await updateDoc(doc(db, "machines", mId), { status: "WORKING" });
        };

        window.logout = () => signOut(auth);
    </script>
</body>
</html>