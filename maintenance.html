<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mercedes-Benz Plant Operations</title>
  <script src="https://meet.jit.si/external_api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; overflow-x: hidden; }
    /* SIDEBAR */
    .sidebar { width: 260px; border-right: 1px solid #333; height: 100vh; padding: 25px; position: fixed; background: #050505; z-index: 10005; overflow-y: auto; }
    .main { margin-left: 285px; padding: 40px; flex: 1; transition: filter 0.5s ease; }
    #mainPage, #adminPanel, #interventionPage, #missionPage, #historyPage, #kpiTrackerPage, #personnelPage { display: none; background: #111; border-left: 4px solid #e30613; padding: 25px; margin-bottom: 30px; }
    /* Show Dashboard by default */
    #mainPage { display: block; }
    .card { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
    .checklist-item { display: block; margin: 10px 0; font-size: 0.9rem; }
    input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { text-align: left; padding: 15px; color: #666; border-bottom: 2px solid #222; font-size: 0.8rem; }
    td { padding: 15px; border-bottom: 1px solid #1a1a1a; }
    .status-working { color: #00ff00; background: rgba(0, 255, 0, 0.1); padding: 4px 10px; border-radius: 4px; font-weight: bold; }
    .status-breakdown { color: #ff3333; background: rgba(255, 51, 51, 0.1); padding: 4px 10px; border-radius: 4px; font-weight: bold; }
    button { cursor: pointer; padding: 10px 20px; background: #e30613; color: white; border: none; font-weight: bold; transition: 0.3s; }
    button:hover { background: #fff; color: #000; }
    .btn-nav { width: 100%; margin-top: 10px; text-align: left; background: transparent; color: #aaa; border: 1px solid #222; }
    .tech-select { background: #222; color: #fff; border: 1px solid #444; padding: 5px; font-size: 0.7rem; width: auto; }
    /* KPI Alert */
    .kpi-alert { background: #ff3333; color: #fff; padding: 5px; font-weight: bold; border-radius: 4px; display: inline-block; margin-top: 5px; border: 1px solid #fff; }
    /* Step Indicators */
    .step-row { display: flex; align-items: center; margin-bottom: 10px; }
    .step-bubble { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; margin-right: 15px; font-weight: bold; font-size: 14px; }
    .step-green { background: #00ff00; color: #000; }
    .step-red { background: #ff3333; color: #fff; }
    .step-orange { background: #ffa500; color: #000; }
    /* Edited Tag */
    .edited-tag { color: #ffcc00; font-weight: bold; font-size: 0.7rem; border: 1px solid #ffcc00; padding: 2px 5px; border-radius: 3px; margin-left: 10px; }
    /* CALL POPUP */
    #callPopup {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 500px; background: #111; border: 3px solid #e30613; border-radius: 25px;
      padding: 20px; text-align: center; z-index: 10002; box-shadow: 0 0 100px rgba(255,0,0,0.5);
    }
    #videoContainer { width: 100%; height: 350px; background: #000; border-radius: 15px; margin-top: 15px; overflow: hidden; }
    .director-console { background: #000; padding: 15px; border-radius: 15px; margin-top: 20px; border: 1px dashed #444; }
    .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; background: #555; margin-right: 5px; }
    .dot-active { background: #00ff00; box-shadow: 0 0 15px #00ff00; }
    #audioActivator {
      background: #ffcc00; color: #000; border: none; padding: 15px;
      font-weight: 900; width: 100%; margin-bottom: 20px; border-radius: 5px;
      cursor: pointer; display: block; animation: pulse 2s infinite;
    }
    /* DANGER OVERLAY */
    #dangerOverlay {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(150, 0, 0, 0.9); z-index: 9999; flex-direction: column;
      justify-content: center; align-items: center; text-align: center;
    }
    .giant-triangle { font-size: 120px; animation: pulse 0.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    /* ACCESS DENIED MODAL */
    #accessDeniedModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle, #200 0%, #000 100%); z-index: 20000; align-items: center; justify-content: center;
    }
    .security-shield {
      border: 1px solid #e30613; padding: 60px; border-radius: 5px; text-align: center;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
      box-shadow: 0 0 50px rgba(227, 6, 19, 0.2); position: relative; overflow: hidden;
    }
    .security-scan-line {
      position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #e30613;
      box-shadow: 0 0 15px #e30613; animation: scanMove 2s infinite linear;
    }
    @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
    /* MACHINE INFO POPUP */
    #machineDetailPopup {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 700px; max-height: 90vh; background: #050505; border: 2px solid #e30613;
      padding: 30px; z-index: 10010; overflow-y: auto; border-radius: 15px; box-shadow: 0 0 50px #000;
    }
    .history-log { font-size: 0.8rem; background: #000; padding: 10px; border: 1px solid #333; margin-top: 10px; max-height: 150px; overflow-y: auto; }
    .machine-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
    .preview-img { width: 120px; height: 120px; object-fit: cover; margin-right: 10px; border: 2px solid #444; border-radius: 5px; }
    .img-edit-btn { background: #444; color: white; padding: 3px 8px; font-size: 10px; display: block; margin-top: 5px; width: 120px; text-align: center; cursor: pointer; }
    /* KPI DASHBOARD STYLES */
    .kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
    .kpi-hero-card { background: linear-gradient(145deg, #151515, #0a0a0a); border: 1px solid #222; border-radius: 15px; padding: 25px; position: relative; overflow: hidden; }
    .kpi-hero-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #e30613; }
    .kpi-main-val { font-size: 3.5rem; font-weight: 900; font-family: 'Courier New', monospace; color: #fff; margin: 10px 0; display: block; }
    .kpi-sub-label { color: #666; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; }
    .pulse-ring { width: 12px; height: 12px; border-radius: 50%; background: #00ff00; display: inline-block; margin-right: 8px; animation: pulseGreen 1.5s infinite; }
    @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); } }
    .line-health-row { background: #111; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 2px solid #333; }
    .health-bar-bg { background: #222; height: 4px; width: 100%; margin-top: 10px; }
    .health-bar-fill { height: 100%; background: #e30613; transition: 1.5s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 0 10px #e30613; }
    /* PERSONNEL STYLES */
    .tech-profile-card { display: flex; align-items: center; background: #151515; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 15px; transition: 0.3s; cursor: pointer; }
    .tech-profile-card:hover { border-color: #e30613; background: #1a1a1a; }
    .tech-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #333; margin-right: 20px; object-fit: cover; }
    .tech-info { flex-grow: 1; }
    .tech-name { font-weight: bold; font-size: 1.1rem; color: #fff; }
    .tech-status { font-size: 0.8rem; display: flex; align-items: center; margin-top: 5px; }
    .status-dot-small { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    .perm-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-top: 15px; }
    .perm-chip { font-size: 10px; padding: 6px; border: 1px solid #333; text-align: center; cursor: pointer; border-radius: 4px; background: #0a0a0a; color: #666; }
    .perm-active { background: #e30613; border-color: #e30613; color: #fff; box-shadow: 0 0 10px rgba(227, 6, 19, 0.3); }
    /* === PERSONNEL: Tech Profile Modal & Direct Call (NEW) === */
    #techProfilePopup, #directCallPopup {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 680px; max-height: 90vh; overflow-y: auto;
      background: #0b0b0b; border: 2px solid #e30613;
      border-radius: 14px; padding: 24px; z-index: 10012;
      box-shadow: 0 0 50px #000;
    }
    .modal-title { margin: 0 0 10px 0; color: #e30613; letter-spacing: 1px; }
    .modal-subtle { color: #777; font-size: 11px; margin-bottom: 10px; }
    .modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .modal-actions { display: flex; gap: 10px; margin-top: 12px; }
    .btn-ghost { background: transparent; border: 1px solid #444; color: #bbb; }
    .btn-danger { background: #b10000; }
    .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 4px; border: 1px solid #333; margin-left: 8px; }
    .status-active { color: #00ff00; border-color: #093; }
    .status-leave { color: #ffcc00; border-color: #aa8d00; }
    .status-suspended { color: #ffa500; border-color: #a96f00; }
    .status-blocked { color: #ff3333; border-color: #a10000; }
    .request-glow { box-shadow: 0 0 0 0 rgba(255,204,0,0.4); animation: reqPulse 1.6s infinite; }
    @keyframes reqPulse { 0% { box-shadow: 0 0 0 0 rgba(255,204,0,0.4); } 70% { box-shadow: 0 0 0 16px rgba(255,204,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,204,0,0); }
    }
    /* Direct call video container */
    #directVideoContainer { width: 100%; height: 350px; background: #000; border-radius: 12px; overflow: hidden; }
    /* Incoming banner (kept but unused now) */
    #incomingCallBanner { display:none; }
    /* A11y helper: visible to screen readers, hidden visually */
    .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; border: 0; }
  /* NEW: History Image Management & Tagging */
.img-edit-btn { background: #444; color: white; padding: 3px 8px; font-size: 10px; display: block; margin-top: 5px; width: 120px; text-align: center; cursor: pointer; }
.img-edit-btn:hover { background: #e30613; }
.edited-tag { color: #ffcc00; font-weight: bold; font-size: 0.7rem; border: 1px solid #ffcc00; padding: 2px 5px; border-radius: 3px; margin-left: 10px; }
 </style>
</head>
<body>
  <audio id="effectAudio" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
  <div id="accessDeniedModal">
    <div class="security-shield">
      <div class="security-scan-line"></div>
      <h1 style="font-size: 4rem; color: #e30613; margin: 0; font-family: monospace;">[!]</h1>
      <h2 style="letter-spacing: 8px; color: #fff;">SECURITY VIOLATION</h2>
      <p id="deniedText" style="color: #666; font-size: 0.8rem;">BIOMETRIC SIGNATURE NOT RECOGNIZED.<br>ENCRYPTION LEVEL 102 ACTIVE.</p>
      <button onclick="document.getElementById('accessDeniedModal').style.display='none'" style="margin-top:30px; background:transparent; border: 1px solid #e30613; color: #e30613; padding: 10px 40px;">DISMISS</button>
    </div>
  </div>
  <div id="machineDetailPopup">
    <div id="machineDetailContent"></div>
    <button onclick="document.getElementById('machineDetailPopup').style.display='none'" style="width:100%; margin-top:15px; background:#444;">CLOSE</button>
  </div>
  <div id="techProfilePopup">
    <h2 class="modal-title">Technician Profile</h2>
    <div id="techIdentityLine" class="modal-subtle"></div>
    <div class="modal-row">
      <div>
        <label for="techPositionInput">Position</label>
        <input type="text" id="techPositionInput" placeholder="e.g., Senior Maintenance Technician">
      </div>
      <div>
        <label for="techStatusSelect">Status</label>
        <select id="techStatusSelect">
          <option value="Active">Active</option>
          <option value="On Leave">On Leave</option>
          <option value="Suspended">Suspended</option>
          <option value="Blocked">Blocked</option>
        </select>
      </div>
    </div>
    <label for="techDescriptionInput" style="margin-top:8px;">Full Description</label>
    <textarea id="techDescriptionInput" rows="5" placeholder="Team, capabilities, specialization, shift info‚Ä¶"></textarea>
    <div class="modal-actions">
      <button id="saveTechProfileBtn" onclick="window.saveTechProfile()" style="background:#28a745;">SAVE CHANGES</button>
      <button class="btn-ghost" onclick="document.getElementById('techProfilePopup').style.display='none'">CLOSE</button>
      <button class="btn-danger" style="margin-left:auto" onclick="window.blockAllAccess()">BLOCK ALL ACCESS</button>
      <button class="btn-ghost" onclick="window.directCallTechFromProfile()">üìû DIRECT CALL</button>
    </div>
  </div>
  <div id="directCallPopup">
    <h2 class="modal-title">Direct Line</h2>
    <div id="directCallTitle" class="modal-subtle"></div>
    <div id="directVideoContainer"></div>
    <div class="modal-actions" style="margin-top:12px;">
      <button class="btn-danger" onclick="window.endDirectCall()">HANG UP</button>
    </div>
  </div>
  <div id="callPopup">
    <h2 style="font-size: 1.2rem; margin: 0;">DIRECTOR EMERGENCY LINE</h2>
    <p id="callMachineName" style="color: #e30613; font-weight: bold; margin: 5px 0;"></p>
    <div id="videoContainer"></div>
    <div id="mohamedConsole" class="director-console" style="display:none;">
      <button onclick="window.triggerRemoteAudio()" style="background:#ffcc00; color:#000; font-size: 12px; width: 100%;">üîî SEND ALERT SOUND</button>
    </div>
    <button id="hangUpBtn" style="background:#ff3333; border-radius:50%; width:50px; height:50px; border:none; color:white; font-size:1.2rem; margin-top:15px;" onclick="window.endEmergencyCall()">üìû</button>
    <div style="margin-top:10px; font-size:11px; border-top:1px solid #333; padding-top:10px;">
      <span id="statusDot" class="status-dot"></span> <span id="webrtcState">DIRECT LINE ENCRYPTED</span>
    </div>
  </div>
  <div id="dangerOverlay">
    <div class="giant-triangle">‚ö†Ô∏è</div>
    <div style="font-size: 2.5rem; font-weight: 900;">DANGER</div>
    <div id="dangerDescription" style="background:black; padding:10px 20px; margin-top:20px; font-size: 1.5rem;"></div>
    <div style="margin-top:10px; font-style: italic; color: #ffcc00;">Assigned to resolve - Connecting to Director...</div>
  </div>
  <div class="sidebar" id="mainSidebar">
    <h2 style="color: #e30613;">MERCEDES</h2>
    <button id="audioActivator" onclick="window.activateAudioSystem()">STEP 1: ENABLE MIC</button>
    <p id="userDisplay" style="font-size: 11px; color: #666;"></p>
    <div id="reqPermissionBox" style="display:none; margin-bottom: 10px;">
      <button onclick="window.requestAccess()" style="background:#444; font-size: 10px; width: 100%; padding: 5px;">PROMPT MOHAMED FOR ACCESS</button>
    </div>
    <hr style="border:0; border-top:1px solid #333;">
    <button class="btn-nav" id="nav_mainPage" onclick="window.showPage('mainPage')">üè† Dashboard</button>
    <button class="btn-nav" id="nav_interventionPage" onclick="window.showPage('interventionPage')">üìù Interventions</button>
    <button class="btn-nav" id="nav_missionPage" onclick="window.showPage('missionPage')">üõ†Ô∏è Missions</button> <button class="btn-nav" id="nav_historyPage" onclick="window.showPage('historyPage')">üìö History</button>
    <button class="btn-nav" id="nav_kpiTrackerPage" onclick="window.showPage('kpiTrackerPage')">üìä KPI Command</button>
    <button class="btn-nav" id="nav_personnelPage" onclick="window.showPage('personnelPage')" style="border: 1px solid #e30613; color: #e30613;">üë• Personnel</button>
    <button onclick="window.logout()" style="width: 100%; margin-top: 20px;">SIGN OUT</button>
  </div>
  <div class="main" id="contentMain">
    <div id="personnelPage">
      <h1 style="letter-spacing: 5px;">PERSONNEL & ACCESS CONTROL</h1>
      <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
        <div>
          <div class="card" id="securityMatrixCard" style="border-top: 4px solid #e30613;">
            <h3 style="margin-top:0;">SECURITY & ACCESS MATRIX</h3>
            <p style="font-size: 12px; color: #666;">Select a technician to manage permissions and initiate calls.</p>
            <div id="userAccessList"></div>
          </div>
        </div>
        <div>
          <div class="card" style="border: 2px solid #ffcc00;">
            <h3 style="color:#ffcc00; margin-top:0;">ACTIVE BREAKDOWNS (CALLS)</h3>
            <div id="breakdownCallList"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="adminPanel">
      <h3>DIRECTOR CONTROL</h3>
      <div id="adminApprovalList"></div>
      <hr style="border-color: #333; margin: 20px 0;">
      <div class="card">
        <h4>DATA SYNCHRONIZATION</h4>
        <label for="jsonInput">Machines JSON</label>
        <input type="file" id="jsonInput" accept=".json">
        <button onclick="window.syncDatabase()" style="width: 100%; background: #28a745;">PUSH 105 MACHINES</button>
      </div>
    </div>
    <div id="mainPage">
      <h1>Plant Asset Library</h1>
      <table>
        <thead><tr><th>ID</th><th>NAME</th><th>SECTION</th><th>STATUS</th><th>ACTIONS</th></tr></thead>
        <tbody id="assetTable"></tbody>
      </table>
    </div>
    <div id="interventionPage">
      <h1>Step 1: Request Intervention</h1>
      <div class="card" id="interventionCard">
        <label for="reqMachine">Machine</label>
        <select id="reqMachine" onchange="window.previewMachine(this.value)"></select>
        <label for="reqIssue">Issue description</label>
        <textarea id="reqIssue" placeholder="Describe the failure..."></textarea>
        <button id="submitReqBtn" onclick="window.submitReq()">SUBMIT TO DIRECTOR</button>
      </div>
    </div>
    <div id="missionPage">
      <h1>Step 3: Technical Missions</h1>
      <div id="missionList"></div>
    </div>
    <div id="historyPage">
      <h1>Maintenance Archive</h1>
      <div class="card">
        <label class="sr-only" for="historySearch">Search by Machine Name</label>
        <input type="text" id="historySearch" placeholder="Search by Machine Name..." onkeyup="window.filterHistory()">
        <label class="sr-only" for="historyDateSort">Sort order</label>
        <select id="historyDateSort" onchange="window.filterHistory()">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>
      </div>
      <div id="historyList"></div>
    </div>
    <div id="kpiTrackerPage">
      <h1 style="letter-spacing: 5px; text-shadow: 0 0 20px rgba(227,6,19,0.5);">STRATEGIC MISSION CONTROL</h1>
      <div class="kpi-container">
        <div class="kpi-hero-card">
          <span class="kpi-sub-label">Global Plant Efficiency</span>
          <span id="globalKpiVal" class="kpi-main-val">0%</span>
          <div class="health-bar-bg"><div id="globalKpiFill" class="health-bar-fill" style="width:0%"></div></div>
        </div>
        <div class="kpi-hero-card">
          <span class="kpi-sub-label">Active Deployments</span>
          <span id="activeMissionsVal" class="kpi-main-val" style="color:#ffcc00;">0</span>
          <p style="font-size:10px; color:#555;">Live technical interventions</p>
        </div>
        <div class="kpi-hero-card">
          <span class="kpi-sub-label">System Integrity</span>
          <span class="kpi-main-val" style="color:#00ff00;">STABLE</span>
          <div style="font-size:11px;"><span class="pulse-ring"></span> Real-time Telemetry</div>
        </div>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top:20px;">
        <div class="card">
          <h3>LINE TELEMETRY</h3>
          <div id="lineHealthContent"></div>
        </div>
        <div class="card">
          <h3>ELITE TECHNICIAN PERFORMANCE</h3>
          <table style="margin-top:0">
            <thead>
              <tr>
                <th>IDENTIFIER</th>
                <th>MTTR ACCURACY</th>
                <th>RATING</th>
              </tr>
            </thead>
            <tbody id="techKpiTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, onSnapshot, doc, setDoc, updateDoc, addDoc, query, where, deleteDoc, getDocs, serverTimestamp, getDoc, arrayUnion, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const DIRECTOR = "mohamed.aouladzerouali@jobson.com";
    let techList = [], micReady = false, machineCache = {}, archivedInterventions = [], jitsiApi = null;
    let userPermissions = {};
    let currentTechEmailForEdit = null;
    let directJitsiApi = null;
    let lastEmergencyTarget = null; // stores current emergency target to avoid race conditions

    const M_STEPS = {
      "ROBOTIC": ["Check axis calibration", "Inspect hydraulic lines", "Verify servo motor temperature", "Software diagnostic run", "End-effector alignment", "Safety barrier test"],
      "PRESS": ["Oil pressure check", "Die alignment inspection", "Lubrication cycle test", "Safety light curtain check", "Ram stroke measurement", "Plate cleaning"],
      "ASSEMBLY": ["Conveyor belt tension", "Sensor debris cleaning", "Pneumatic valve check", "Fastener torque audit", "Control panel inspection", "Emergency stop test"],
      "DEFAULT": ["General visual inspection", "Power supply check", "Input/Output verification", "Component cleaning", "Operational test", "Safety check"]
    };

    /* ======== ADDED: PDF GENERATOR (jsPDF) ======== */
    // Charge une signature (username -> images/Signatures/<username>.png)
    async function loadSignature(username) {
      try {
        const fname = (username || '').split("@")[0].toLowerCase() + ".png";
        const url = "images/Signatures/" + fname;
        return new Promise((resolve) => {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
          img.src = url + "?t=" + Date.now(); // bust cache
        });
      } catch { return null; }
    }

    // G√©n√®re un PDF pour demande / ordre de mission / cl√¥ture
    async function generatePDF(data, title) {
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const machineName = data?.machineName || "Unknown Machine";
        const requester = data?.requester || "Unknown";
        const bodyText = (data?.issue || data?.techComment || "").toString();

        pdf.setFontSize(18);
        pdf.text(title, 10, 20);
        pdf.setFontSize(12);
        pdf.text("Machine : " + machineName, 10, 30);
        pdf.text("Requester : " + requester, 10, 40);
        pdf.text("Date : " + new Date().toLocaleString(), 10, 50);
        pdf.text("Description : ", 10, 65);
        pdf.setFontSize(10);
        pdf.text(bodyText, 10, 75, { maxWidth: 180 });

        // Draw signature of the user who is creating this PDF
        const signature = await loadSignature(auth.currentUser?.email);
        if (signature) {
          pdf.text("Digital Signature:", 10, 150);
          pdf.addImage(signature, 'PNG', 10, 155, 40, 20);
        }

        pdf.save(`${title.replace(/\s/g, '_')}_${machineName}.pdf`);
      } catch (e) {
        console.error("PDF Error:", e);
      }
    }
    window.generatePDF = generatePDF;

    /* ======== AUDIO SYSTEM (Mic + Effects) ======== */
    window.activateAudioSystem = async () => {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        micReady = true;
        document.getElementById('audioActivator').style.display = 'none';
        console.log("Audio logic enabled.");
      } catch (e) {
        alert("Microphone permission denied. Emergency calls may fail.");
      }
    };

    /* ======== DATABASE SYNC ======== */
    window.syncDatabase = async () => {
      const file = document.getElementById('jsonInput').files[0];
      if (!file) return alert("Select a JSON file first.");
      const text = await file.text();
      const data = JSON.parse(text);
      for (const machine of data) {
        await setDoc(doc(db, "assets", machine.id), machine);
      }
      alert("Database Refreshed with 105 assets!");
    };

    /* ======== NAVIGATION ======== */
    window.showPage = (id) => {
      ['mainPage', 'adminPanel', 'interventionPage', 'missionPage', 'historyPage', 'kpiTrackerPage', 'personnelPage'].forEach(p => {
        const el = document.getElementById(p);
        if (el) el.style.display = 'none';
      });
      document.getElementById(id).style.display = 'block';
    };

    /* ======== PERMISSIONS / ACCESS ======== */
    window.requestAccess = async () => {
      const email = auth.currentUser.email;
      await setDoc(doc(db, "access_requests", email), {
        email,
        timestamp: serverTimestamp(),
        status: "pending"
      });
      alert("Request sent to Mohamed.");
    };

    /* ======== EMERGENCY CALLS ======== */
    window.startEmergencyCall = (machineId, machineName) => {
      if (!micReady) return alert("Enable microphone (Step 1) first.");
      lastEmergencyTarget = machineId;
      document.getElementById('callPopup').style.display = 'block';
      document.getElementById('callMachineName').innerText = machineName;
      document.getElementById('videoContainer').innerHTML = "";

      const options = {
        roomName: "MERCEDES_EMERGENCY_" + machineId,
        width: "100%",
        height: "100%",
        parentNode: document.getElementById('videoContainer'),
        configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: false }
      };
      jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", options);

      jitsiApi.addEventListener('videoConferenceLeft', () => {
        window.endEmergencyCall();
      });

      if (auth.currentUser.email === DIRECTOR) {
        document.getElementById('mohamedConsole').style.display = 'block';
      }
    };

    window.endEmergencyCall = async () => {
      if (jitsiApi) jitsiApi.dispose();
      document.getElementById('callPopup').style.display = 'none';
      document.getElementById('mohamedConsole').style.display = 'none';
      // If closing as tech, update machine to clear emergency flag
      if (lastEmergencyTarget) {
        await updateDoc(doc(db, "assets", lastEmergencyTarget), { emergency: false });
        lastEmergencyTarget = null;
      }
    };

    window.triggerRemoteAudio = () => {
      // In a real RTC scenario, we'd use Jitsi's data channel or Firestore. 
      // For simplicity here, we write a trigger to Firestore that the machine (tech) listens to.
      if (lastEmergencyTarget) {
        updateDoc(doc(db, "assets", lastEmergencyTarget), { audioTrigger: Date.now() });
      }
    };

    /* ======== ASSETS & INTERVENTIONS ======== */
    onSnapshot(collection(db, "assets"), (snap) => {
      const tbody = document.getElementById('assetTable');
      const select = document.getElementById('reqMachine');
      tbody.innerHTML = "";
      select.innerHTML = '<option value="">-- Choose Machine --</option>';

      snap.forEach(d => {
        const m = d.data();
        machineCache[m.id] = m;

        // Table
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.id}</td>
          <td>${m.name}</td>
          <td>${m.section}</td>
          <td><span class="${m.status === 'Working' ? 'status-working' : 'status-breakdown'}">${m.status}</span></td>
          <td><button onclick="window.viewMachine('${m.id}')">VIEW</button></td>
        `;
        tbody.appendChild(tr);

        // Select
        const opt = document.createElement('option');
        opt.value = m.id; opt.innerText = m.name;
        select.appendChild(opt);

        // Danger Logic
        if (m.emergency && auth.currentUser.email !== DIRECTOR) {
          const overlay = document.getElementById('dangerOverlay');
          overlay.style.display = 'flex';
          document.getElementById('dangerDescription').innerText = `CRITICAL FAILURE: ${m.name}`;
          document.getElementById('effectAudio').play();
          // Auto-join call if assigned or critical? For now, button click is safer.
        } else {
          // If this machine was the last emergency and it's resolved, hide overlay
          if (lastEmergencyTarget === m.id && !m.emergency) {
             document.getElementById('dangerOverlay').style.display = 'none';
          }
        }

        // Remote Audio Trigger
        if (m.audioTrigger && m.audioTrigger > (Date.now() - 5000)) {
           document.getElementById('effectAudio').play();
        }
      });
    });

    window.viewMachine = (id) => {
      const m = machineCache[id];
      const historyHtml = archivedInterventions
        .filter(i => i.machineId === id)
        .map(i => `<div class="history-log"><b>${i.closedAt}</b>: ${i.techComment}</div>`)
        .join('');

      document.getElementById('machineDetailContent').innerHTML = `
        <img src="${m.image || 'https://via.placeholder.com/600x200'}" class="machine-img">
        <h2>${m.name} [${m.id}]</h2>
        <p><b>Section:</b> ${m.section}</p>
        <p><b>Last MTTR:</b> ${m.mttr || 'N/A'} mins</p>
        <hr>
        <h4>Maintenance Log</h4>
        ${historyHtml || 'No previous logs.'}
      `;
      document.getElementById('machineDetailPopup').style.display = 'block';
    };

    window.submitReq = async () => {
      const mid = document.getElementById('reqMachine').value;
      const issue = document.getElementById('reqIssue').value;
      if (!mid || !issue) return alert("Fill all fields.");

      const payload = {
        machineId: mid,
        machineName: machineCache[mid].name,
        issue,
        requester: auth.currentUser.email,
        status: "pending",
        timestamp: serverTimestamp()
      };

      await addDoc(collection(db, "interventions"), payload);
      await updateDoc(doc(db, "assets", mid), { status: "Breakdown" });
      alert("Breakdown Reported.");
      generatePDF(payload, "INTERVENTION REQUEST");
    };

    /* ======== MISSIONS (STEPS) ======== */
    onSnapshot(query(collection(db, "interventions"), where("status", "==", "approved")), (snap) => {
      const list = document.getElementById('missionList');
      list.innerHTML = "";
      snap.forEach(d => {
        const i = d.data();
        const m = machineCache[i.machineId];
        const steps = M_STEPS[m.section] || M_STEPS.DEFAULT;

        const card = document.createElement('div');
        card.className = "card";
        card.innerHTML = `
          <h3>MISSION: ${i.machineName}</h3>
          <p><b>Reported by:</b> ${i.requester}</p>
          <p><b>Issue:</b> ${i.issue}</p>
          <div style="margin: 20px 0;">
            ${steps.map((s, idx) => `
              <div class="step-row">
                <div class="step-bubble step-orange" id="step_${d.id}_${idx}">${idx + 1}</div>
                <span>${s}</span>
                <button style="margin-left: auto; font-size: 10px; padding: 5px;" onclick="window.completeStep('${d.id}', ${idx})">DONE</button>
              </div>
            `).join('')}
          </div>
          <button onclick="window.startEmergencyCall('${m.id}', '${m.name}')" style="background:#ffcc00; color:#000; width:100%;">üìû REQUEST DIRECTOR SUPPORT</button>
          <hr>
          <label>Before Image (URL)</label>
          <input type="text" id="imgBefore_${d.id}" placeholder="https://...">
          <label>After Image (URL)</label>
          <input type="text" id="imgAfter_${d.id}" placeholder="https://...">
          <label>Technical Resolution Report</label>
          <textarea id="closing_${d.id}" placeholder="Explain what was fixed..."></textarea>
          <button onclick="window.closeMission('${d.id}')" style="width:100%; background:#28a745;">CLOSE INTERVENTION</button>
        `;
        list.appendChild(card);
      });
    });

    window.completeStep = (id, idx) => {
      const el = document.getElementById(`step_${id}_${idx}`);
      el.className = "step-bubble step-green";
    };

    window.closeMission = async (id) => {
      const comment = document.getElementById(`closing_${id}`).value;
      const imgB = document.getElementById(`imgBefore_${id}`).value;
      const imgA = document.getElementById(`imgAfter_${id}`).value;

      const docRef = doc(db, "interventions", id);
      const snap = await getDoc(docRef);
      const data = snap.data();

      const closureData = {
        ...data,
        status: "closed",
        techComment: comment,
        imageBefore: imgB,
        imageAfter: imgA,
        closedAt: new Date().toLocaleString()
      };

      await updateDoc(docRef, closureData);
      await updateDoc(doc(db, "assets", data.machineId), { status: "Working", emergency: false });
      alert("Mission Accomplished.");
      generatePDF(closureData, "MAINTENANCE CLOSURE REPORT");
    };

    /* ======== HISTORY & FILTER ======== */
    onSnapshot(query(collection(db, "interventions"), where("status", "==", "closed"), orderBy("timestamp", "desc")), (snap) => {
      archivedInterventions = [];
      snap.forEach(d => archivedInterventions.push({ id: d.id, ...d.data() }));
      window.filterHistory();
    });

    window.filterHistory = () => {
      const queryStr = document.getElementById('historySearch').value.toLowerCase();
      const sort = document.getElementById('historyDateSort').value;
      let filtered = archivedInterventions.filter(i => (i.machineName || '').toLowerCase().includes(queryStr));

      if (sort === "oldest") filtered.reverse();

      const list = document.getElementById('historyList');
      list.innerHTML = "";
      filtered.forEach(i => {
        const div = document.createElement('div');
        div.className = "card";
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
             <h3>${i.machineName}</h3>
             ${i.edited ? `<span class="edited-tag">EDITED BY DIRECTOR</span>` : ''}
          </div>
          <p><b>Date:</b> ${i.closedAt}</p>
          <p><b>Issue:</b> ${i.issue}</p>
          <p style="color:#00ff00;"><b>Resolution:</b> ${i.techComment}</p>
          <div style="display:flex; gap:10px;">
            <div>
              <small>BEFORE</small><br>
              ${i.imageBefore ? `<img src="${i.imageBefore}" class="preview-img">` : '<div class="preview-img" style="border:1px dashed #333; display:flex; align-items:center; justify-content:center;">No Image</div>'}
              <span class="img-edit-btn" onclick="window.updateHistoryImage('${i.id}', 'imageBefore')">REPLACE</span>
              <span class="img-edit-btn" style="color:red;" onclick="window.deleteImage('${i.id}', 'imageBefore')">DELETE</span>
            </div>
            <div>
              <small>AFTER</small><br>
              ${i.imageAfter ? `<img src="${i.imageAfter}" class="preview-img">` : '<div class="preview-img" style="border:1px dashed #333; display:flex; align-items:center; justify-content:center;">No Image</div>'}
              <span class="img-edit-btn" onclick="window.updateHistoryImage('${i.id}', 'imageAfter')">REPLACE</span>
              <span class="img-edit-btn" style="color:red;" onclick="window.deleteImage('${i.id}', 'imageAfter')">DELETE</span>
            </div>
          </div>
          <button onclick="window.forceModifyReport('${i.id}')" style="background:#ffcc00; color:#000; margin-top:15px; width:100%">FORCE EDIT TEXT LOGS</button>
        `;
        list.appendChild(div);
      });
    };

    /* ======== DIRECTOR: History Management ======== */
    window.updateHistoryImage = async (docId, field) => {
      if (auth.currentUser.email !== DIRECTOR) return alert("Director level required.");
      const newUrl = prompt("Enter new Image URL:");
      if (newUrl) {
        await updateDoc(doc(db, "interventions", docId), { [field]: newUrl, edited: true });
      }
    };
    window.deleteImage = async (docId, field) => {
      if (auth.currentUser.email !== DIRECTOR) return alert("Director level required.");
      if (confirm("Permanently remove this image from history?")) {
        await updateDoc(doc(db, "interventions", docId), { [field]: "", edited: true });
      }
    };
    window.forceModifyReport = async (docId) => {
      if (auth.currentUser.email !== DIRECTOR) return alert("Director level required.");
      const newTxt = prompt("Overwrite Technical Resolution Log:");
      if (newTxt) {
        await updateDoc(doc(db, "interventions", docId), { techComment: newTxt, edited: true });
      }
    };

    /* ======== KPI DASHBOARD LOGIC ======== */
    const updateKpiUI = () => {
      const activeInterventionsCount = archivedInterventions.filter(i => i.status !== "closed").length;
      document.getElementById('activeMissionsVal').innerText = activeInterventionsCount;

      const workingCount = Object.values(machineCache).filter(m => m.status === "Working").length;
      const totalCount = Object.values(machineCache).length || 1;
      const efficiency = Math.round((workingCount / totalCount) * 100);

      document.getElementById('globalKpiVal').innerText = efficiency + "%";
      document.getElementById('globalKpiFill').style.width = efficiency + "%";

      const lineContent = document.getElementById('lineHealthContent');
      lineContent.innerHTML = "";
      const sections = [...new Set(Object.values(machineCache).map(m => m.section))];
      sections.forEach(sec => {
        const secMachines = Object.values(machineCache).filter(m => m.section === sec);
        const secWorking = secMachines.filter(m => m.status === "Working").length;
        const secHealth = Math.round((secWorking / secMachines.length) * 100);

        const row = document.createElement('div');
        row.className = "line-health-row";
        row.innerHTML = `
          <div style="display:flex; justify-content:space-between; font-size:12px;">
            <span>${sec}</span>
            <span>${secHealth}%</span>
          </div>
          <div class="health-bar-bg"><div class="health-bar-fill" style="width:${secHealth}%"></div></div>
        `;
        lineContent.appendChild(row);
      });

      const techTable = document.getElementById('techKpiTable');
      techTable.innerHTML = "";
      techList.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.email.split('@')[0].toUpperCase()}</td>
          <td>98.2%</td>
          <td style="color:#ffcc00;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</td>
        `;
        techTable.appendChild(tr);
      });
    };

    /* ======== PERSONNEL: SECURITY MATRIX & CALLING ======== */
    const updatePersonnelUI = () => {
      const list = document.getElementById('userAccessList');
      list.innerHTML = "";
      techList.forEach(tech => {
        const perms = userPermissions[tech.email] || {};
        const isRequesting = (tech.status === 'pending');

        const card = document.createElement('div');
        card.className = `tech-profile-card ${isRequesting ? 'request-glow' : ''}`;
        card.onclick = () => window.openTechProfile(tech.email);

        card.innerHTML = `
          <img src="https://ui-avatars.com/api/?name=${tech.email}&background=e30613&color=fff" class="tech-avatar">
          <div class="tech-info">
            <div class="tech-name">${tech.email.split('@')[0]} <span class="status-badge ${getStatusClass(perms.accountStatus)}">${perms.accountStatus || 'Active'}</span></div>
            <div class="tech-status">
              <span class="status-dot-small" style="background:${isRequesting ? '#ffcc00' : '#00ff00'}"></span>
              ${isRequesting ? 'PENDING ACCESS REQUEST' : (perms.accountStatus === 'Active' ? 'System Online' : 'Access Restricted')}
            </div>
            <div class="perm-grid">
              ${['Interventions', 'Missions', 'History', 'KPI', 'Direct_Call'].map(p => `
                <div class="perm-chip ${perms[p] ? 'perm-active' : ''}">${p.replace('_', ' ')}</div>
              `).join('')}
            </div>
          </div>
        `;
        list.appendChild(card);
      });

      // Breakdowns Call List
      const callList = document.getElementById('breakdownCallList');
      callList.innerHTML = "";
      Object.values(machineCache).filter(m => m.emergency).forEach(m => {
        const btn = document.createElement('button');
        btn.style = "width:100%; margin-bottom:10px; text-align:left; background:#111; border:1px solid #ff3333;";
        btn.innerHTML = `<span style="color:#ff3333;">[LIVE]</span> ${m.name} Emergency Line`;
        btn.onclick = () => window.startEmergencyCall(m.id, m.name);
        callList.appendChild(btn);
      });
    };

    function getStatusClass(s) {
      if (s === 'Active') return 'status-active';
      if (s === 'On Leave') return 'status-leave';
      if (s === 'Suspended') return 'status-suspended';
      if (s === 'Blocked') return 'status-blocked';
      return 'status-active';
    }

    window.openTechProfile = async (email) => {
      if (auth.currentUser.email !== DIRECTOR) return alert("Director access only.");
      currentTechEmailForEdit = email;
      const perms = userPermissions[email] || {};
      const profile = (await getDoc(doc(db, "tech_profiles", email))).data() || {};

      document.getElementById('techIdentityLine').innerText = email;
      document.getElementById('techPositionInput').value = profile.position || "";
      document.getElementById('techStatusSelect').value = perms.accountStatus || "Active";
      document.getElementById('techDescriptionInput').value = profile.description || "";
      document.getElementById('techProfilePopup').style.display = 'block';
    };

    window.saveTechProfile = async () => {
      const email = currentTechEmailForEdit;
      const status = document.getElementById('techStatusSelect').value;
      const pos = document.getElementById('techPositionInput').value;
      const desc = document.getElementById('techDescriptionInput').value;

      await setDoc(doc(db, "tech_profiles", email), { position: pos, description: desc }, { merge: true });
      await setDoc(doc(db, "permissions", email), { accountStatus: status }, { merge: true });

      // If they were pending, clear the request
      const reqRef = doc(db, "access_requests", email);
      const reqSnap = await getDoc(reqRef);
      if (reqSnap.exists()) await deleteDoc(reqRef);

      alert("Profile & Permissions Updated.");
      document.getElementById('techProfilePopup').style.display = 'none';
    };

    window.blockAllAccess = async () => {
      if (!confirm("BLOCK ALL SYSTEM ACCESS FOR THIS USER?")) return;
      await setDoc(doc(db, "permissions", currentTechEmailForEdit), {
        accountStatus: "Blocked",
        Interventions: false, Missions: false, History: false, KPI: false, Direct_Call: false
      }, { merge: true });
      alert("USER PERMANENTLY BLOCKED.");
      document.getElementById('techProfilePopup').style.display = 'none';
    };

    /* ======== DIRECT CALLING SYSTEM ======== */
    window.directCallTechFromProfile = () => {
      const targetEmail = currentTechEmailForEdit;
      document.getElementById('directCallPopup').style.display = 'block';
      document.getElementById('directCallTitle').innerText = "Encrypted Line to " + targetEmail;
      document.getElementById('directVideoContainer').innerHTML = "";

      const options = {
        roomName: "MERC_DIRECT_" + targetEmail.replace(/[^a-zA-Z0-9]/g, ""),
        width: "100%", height: "100%",
        parentNode: document.getElementById('directVideoContainer')
      };
      directJitsiApi = new JitsiMeetExternalAPI("meet.jit.si", options);
    };

    window.endDirectCall = () => {
      if (directJitsiApi) directJitsiApi.dispose();
      document.getElementById('directCallPopup').style.display = 'none';
    };

    /* ======== AUTH & DATA INIT ======== */
    onAuthStateChanged(auth, (user) => {
      if (!user) return location.href = "index.html";
      document.getElementById('userDisplay').innerText = `IDENTIFIED: ${user.email}`;

      if (user.email === DIRECTOR) {
        document.getElementById('nav_personnelPage').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none'; // Toggle if needed
      }

      // Listen for my own permissions
      onSnapshot(doc(db, "permissions", user.email), (d) => {
        if (d.exists()) {
          const p = d.data();
          if (p.accountStatus === 'Blocked') {
             document.getElementById('contentMain').innerHTML = "<h1 style='color:red; text-align:center; margin-top:100px;'>SYSTEM ACCESS REVOKED - CONTACT DIRECTOR</h1>";
             document.getElementById('mainSidebar').style.display = 'none';
          }
          // Hide/Show sidebar buttons based on perms
          if (user.email !== DIRECTOR) {
            ['Interventions', 'Missions', 'History', 'KPI'].forEach(key => {
              const btn = document.getElementById('nav_' + key.toLowerCase() + 'Page');
              if (btn) btn.style.display = p[key] ? 'block' : 'none';
            });
          }
        } else if (user.email !== DIRECTOR) {
          // No perms yet? Show request button
          document.getElementById('reqPermissionBox').style.display = 'block';
        }
      });

      // Master Listeners for Director
      if (user.email === DIRECTOR) {
        // Fetch all technicians (anyone who requested access or exists in perms)
        onSnapshot(collection(db, "access_requests"), (snap) => {
           // Merging tech list with pending requests
           const pending = [];
           snap.forEach(d => pending.push({ email: d.id, status: 'pending' }));
           // We also want to see everyone who ALREADY has perms
           getDocs(collection(db, "permissions")).then(psnap => {
             const existing = [];
             psnap.forEach(pd => existing.push({ email: pd.id, status: 'approved' }));
             // Unique combine
             const combined = [...pending];
             existing.forEach(e => { if(!combined.find(c => c.email === e.email)) combined.push(e); });
             techList = combined;
             updatePersonnelUI();
             updateKpiUI();
           });
        });

        onSnapshot(collection(db, "permissions"), (snap) => {
          snap.forEach(d => { userPermissions[d.id] = d.data(); });
          updatePersonnelUI();
          updateKpiUI();
        });
      }
    });

    window.logout = () => signOut(auth);

  </script>
</body>
</html>