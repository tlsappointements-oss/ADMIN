<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mercedes-Benz | Plant Operations</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; }
        .sidebar { width: 250px; border-right: 1px solid #333; height: 100vh; padding: 20px; }
        .main { flex: 1; padding: 40px; }
        #adminPanel { display: none; background: #111; border: 1px solid red; padding: 20px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #222; }
        .status-working { color: #00ff00; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>MERCEDES</h2>
        <p id="userEmail" style="font-size: 12px; color: #888;"></p>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="main">
        <div id="adminPanel">
            <h3>DIRECTOR SYNC PANEL</h3>
            <input type="file" id="jsonUpload" accept=".json">
            <button onclick="syncDatabase()">Push 105 Machines to Live</button>
        </div>

        <h1>Plant Asset Library</h1>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Machine Name</th>
                    <th>Section</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <script type="module">
        import { auth, db } from './firebase.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, onSnapshot, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const DIRECTOR_EMAIL = "mohamed.aouladzerouali@jobson.com";

        // 1. AUTH CHECK & VIEW SETUP
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            const email = user.email.toLowerCase();
            document.getElementById('userEmail').innerText = email;

            // Show admin panel if it's Mohamed
            if (email === DIRECTOR_EMAIL) {
                document.getElementById('adminPanel').style.display = "block";
            }

            // START LISTENING TO DATA
            startLiveListener();
        });

        // 2. LIVE LISTENER (The part that shows data on the website)
        function startLiveListener() {
            const tbody = document.getElementById('tableBody');
            
            // This function runs every time the database changes
            onSnapshot(collection(db, "machines"), (snapshot) => {
                tbody.innerHTML = ""; // Clear table
                
                if (snapshot.empty) {
                    tbody.innerHTML = "<tr><td colspan='4'>No machines found in database.</td></tr>";
                    return;
                }

                snapshot.forEach((d) => {
                    const m = d.data();
                    const row = `
                        <tr>
                            <td>${m.machineId || d.id}</td>
                            <td>${m.name}</td>
                            <td>${m.section}</td>
                            <td class="status-working">${m.status}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }

        // 3. SYNC FUNCTION (Mohamed's Upload Tool)
        window.syncDatabase = async () => {
            const fileInput = document.getElementById('jsonUpload');
            const file = fileInput.files[0];
            if (!file) return alert("Select machines.json first!");

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const machines = JSON.parse(e.target.result);
                    for (const item of machines) {
                        await setDoc(doc(db, "machines", item.id), {
                            machineId: item.id,
                            name: item.name,
                            section: item.section,
                            description: item.desc || "",
                            status: "WORKING",
                            lastUpdated: serverTimestamp(),
                            updatedBy: DIRECTOR_EMAIL
                        }, { merge: true });
                    }
                    alert("Sync Complete!");
                } catch (err) {
                    console.error(err);
                    alert("Error: check console.");
                }
            };
            reader.readAsText(file);
        };

        window.logout = () => signOut(auth);
    </script>
</body>
</html>