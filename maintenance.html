<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Maintenance Dept | Technical Portal</title>
    <style>
        body { display: none; min-height: 100vh; background: #0a0a0a; color: #e0e0e0; margin: 0; font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: 250px; background: #000; border-right: 1px solid #333; padding: 30px 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .gmao-card { background: #111; border: 1px solid #222; padding: 25px; border-radius: 2px; margin-bottom: 20px; }
        .status-indicator { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .status-online { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .status-offline { background: #e30613; box-shadow: 0 0 10px #e30613; }
        input, select, textarea { background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; width: 100%; margin: 10px 0; border-radius: 0; }
        .tech-btn { background: #555; color: white; border: none; padding: 10px 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .tech-btn:hover { background: #777; }
        .nav-btn { background: transparent; border: 1px solid #333; color: #888; padding: 12px; text-align: left; margin-bottom: 10px; cursor: pointer; transition: 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: #e30613; color: white; border-color: #e30613; }
        
        /* Modal for Intervention */
        #intervention-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:999; justify-content:center; align-items:center; }
        .modal-content { background:#111; padding:40px; width:500px; border:1px solid #e30613; }
        .check-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9rem; }
        .check-item input { width: auto; margin: 0; }
    </style>

    <script type="module">
        import { auth, db } from './firebase.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, addDoc, serverTimestamp, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        let currentUserEmail = "";

        onAuthStateChanged(auth, (user) => {
            if (!user || !user.email.toLowerCase().endsWith('@jobson.com')) {
                window.location.replace("login.html");
            } else {
                currentUserEmail = user.email;
                const nameParts = user.email.split('@')[0].split('.');
                const firstName = nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1);
                const lastName = nameParts[1] ? " " + nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : "";
                document.getElementById('techName').innerText = `Technician: ${firstName}${lastName}`;
                document.body.style.display = "flex";
                loadMachineLiveStatus();
            }
        });

        // LIVE DATABASE SYNC
        function loadMachineLiveStatus() {
            onSnapshot(collection(db, "machines"), (snapshot) => {
                const tableBody = document.getElementById('machine-table-body');
                tableBody.innerHTML = "";
                snapshot.forEach((doc) => {
                    const m = doc.data();
                    const statusClass = m.status === "WORKING" ? "status-online" : "status-offline";
                    const row = `
                        <tr style="border-bottom: 1px solid #222;">
                            <td style="padding: 15px;">${m.name}<br><small style="color:#555">${m.description}</small></td>
                            <td>${m.lastService || 'N/A'}</td>
                            <td><span class="status-indicator ${statusClass}"></span> ${m.status}</td>
                            <td>
                                <button class="tech-btn" style="font-size:0.6rem" onclick="openIntervention('${doc.id}', '${m.name}')">
                                    CHANGE STATUS / REPAIR
                                </button>
                            </td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            });
        }

        window.submitIntervention = async () => {
            const machineId = document.getElementById('active-machine-id').value;
            const desc = document.getElementById('work-desc').value;
            
            // 1. Send Report to Mohamed's Collection
            await addDoc(collection(db, "interventions"), {
                technician: currentUserEmail,
                machineId: machineId,
                description: desc,
                timestamp: serverTimestamp(),
                approvedByMohamed: false,
                status: "PENDING_APPROVAL"
            });

            // 2. Set Machine to MAINTENANCE
            const machineRef = doc(db, "machines", machineId);
            await updateDoc(machineRef, { status: "IN MAINTENANCE" });

            document.getElementById('intervention-modal').style.display = 'none';
            alert("Report sent to Mohamed. Machine status updated.");
        };

        window.logout = async () => { await signOut(auth); window.location.replace("login.html"); };
        window.openIntervention = (id, name) => {
            document.getElementById('intervention-modal').style.display = 'flex';
            document.getElementById('active-machine-id').value = id;
            document.getElementById('modal-title').innerText = "Maintenance: " + name;
        };
    </script>
</head>
<body>
    <div class="sidebar">
        <div style="letter-spacing: 3px; font-weight: 300; margin-bottom: 40px;">TECH DEPT</div>
        
        <button class="nav-btn active" onclick="location.reload()">ðŸ“– MACHINE LIBRARY</button>
        <button class="nav-btn" onclick="alert('Accessing Archives...')">ðŸ“‚ HISTORY LOGS</button>
        <button class="nav-btn" onclick="alert('Contacting Mohamed...')">ðŸ“§ CONTACT ADMIN</button>
        
        <div style="margin-top: auto;">
            <p id="techName" style="font-size: 0.7rem; color: #888; margin-bottom: 10px;">Technician: Loading...</p>
            <button class="tech-btn" style="width:100%;" onclick="logout()">Exit System</button>
        </div>
    </div>

    <div class="main-content">
        <h2 style="font-weight: 200; letter-spacing: 2px;">MERCEDES-BENZ PLANT | ASSET MANAGEMENT</h2>
        
        <div class="gmao-card">
            <h3 style="font-weight: 200;">LIVE MACHINE DATABASE</h3>
            <table style="width: 100%; border-collapse: collapse; background: #000; font-size: 0.8rem; margin-top: 20px;">
                <thead style="border-bottom: 1px solid #333; text-align: left; color: #666;">
                    <tr>
                        <th style="padding: 15px;">ASSET NAME & DESCRIPTION</th>
                        <th>LAST SERVICE</th>
                        <th>CURRENT STATUS</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="machine-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="intervention-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="color:#e30613; font-weight: 200;">INTERVENTION FORM</h2>
            <input type="hidden" id="active-machine-id">
            
            <div style="margin: 20px 0;">
                <div class="check-item"><input type="checkbox"> Safety Power-Down Confirmed</div>
                <div class="check-item"><input type="checkbox"> Visual Inspection Done</div>
                <div class="check-item"><input type="checkbox"> Parts Replaced / Lubricated</div>
                <div class="check-item"><input type="checkbox"> Operational Test Successful</div>
            </div>

            <textarea id="work-desc" rows="4" placeholder="Detailed report for Mohamed..."></textarea>
            
            <div style="display:flex; gap:10px;">
                <button class="tech-btn" style="background:#e30613; flex:1;" onclick="submitIntervention()">SUBMIT TO MOHAMED</button>
                <button class="tech-btn" style="flex:1;" onclick="document.getElementById('intervention-modal').style.display='none'">CANCEL</button>
            </div>
        </div>
    </div>
</body>
</html>