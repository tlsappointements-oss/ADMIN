<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALTEN Procurement ‚Äî Secure Access</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --red: #e30613;
  --red-dim: rgba(227,6,19,0.15);
  --red-glow: rgba(227,6,19,0.4);
  --dark: #050709;
  --dark2: #0c0e12;
  --dark3: #111419;
  --border: rgba(255,255,255,0.07);
  --border-bright: rgba(255,255,255,0.14);
  --text: #f0f2f8;
  --text2: #7a8299;
  --text3: #3d4461;
  --mono: 'DM Mono', monospace;
  --sans: 'DM Sans', sans-serif;
  --display: 'Bebas Neue', sans-serif;
}

html,body { height:100%; overflow:hidden; }

body {
  background: var(--dark);
  color: var(--text);
  font-family: var(--sans);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* ANIMATED BACKGROUND GRID */
.bg-grid {
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(227,6,19,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(227,6,19,0.04) 1px, transparent 1px);
  background-size: 60px 60px;
  animation: gridScroll 30s linear infinite;
}
@keyframes gridScroll {
  0%{background-position:0 0}
  100%{background-position:60px 60px}
}

.bg-gradient {
  position: fixed; inset: 0;
  background: radial-gradient(ellipse 60% 80% at 50% 120%, rgba(227,6,19,0.12) 0%, transparent 70%);
  pointer-events: none;
}

/* CORNER DECORATIONS */
.corner {
  position: fixed;
  width: 120px; height: 120px;
  pointer-events: none;
}
.corner-tl { top: 24px; left: 24px; border-top: 1px solid var(--red); border-left: 1px solid var(--red); opacity: 0.3; }
.corner-tr { top: 24px; right: 24px; border-top: 1px solid var(--red); border-right: 1px solid var(--red); opacity: 0.3; }
.corner-bl { bottom: 24px; left: 24px; border-bottom: 1px solid var(--red); border-left: 1px solid var(--red); opacity: 0.3; }
.corner-br { bottom: 24px; right: 24px; border-bottom: 1px solid var(--red); border-right: 1px solid var(--red); opacity: 0.3; }

/* SCAN LINE */
.scan-line {
  position: fixed;
  left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--red), transparent);
  animation: scanDown 8s linear infinite;
  opacity: 0.15;
  pointer-events: none;
}
@keyframes scanDown { from{top:-1px} to{top:100%} }

/* STATUS BAR TOP */
.status-bar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 36px;
  background: rgba(5,7,9,0.9);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 24px;
  z-index: 10;
}
.status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #00e676;
  box-shadow: 0 0 8px #00e676;
  animation: blink 2s ease-in-out infinite;
}
@keyframes blink {0%,100%{opacity:1}50%{opacity:0.3}}
.status-text { font-family: var(--mono); font-size: 9px; color: var(--text2); letter-spacing: 2px; text-transform: uppercase; }
.status-right { margin-left: auto; font-family: var(--mono); font-size: 9px; color: var(--text3); letter-spacing: 1.5px; }

/* MAIN CARD */
.login-wrap {
  position: relative;
  z-index: 5;
  display: flex;
  align-items: center;
  gap: 0;
  width: min(920px, 95vw);
  height: min(600px, 90vh);
}

/* LEFT PANEL ‚Äî Branding */
.left-panel {
  width: 360px;
  flex-shrink: 0;
  height: 100%;
  background: linear-gradient(160deg, var(--dark2) 0%, var(--dark3) 100%);
  border: 1px solid var(--border);
  border-right: none;
  border-radius: 12px 0 0 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 40px;
  overflow: hidden;
  position: relative;
}

.left-panel::before {
  content: '';
  position: absolute;
  top: -60px; right: -60px;
  width: 200px; height: 200px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(227,6,19,0.12) 0%, transparent 70%);
}

.brand-logo {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.brand-name {
  font-family: var(--display);
  font-size: 52px;
  letter-spacing: 6px;
  color: var(--red);
  line-height: 1;
  text-shadow: 0 0 40px rgba(227,6,19,0.4);
}
.brand-sub {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 4px;
  color: var(--text2);
  text-transform: uppercase;
}

.brand-divider {
  width: 40px;
  height: 1px;
  background: var(--red);
  margin: 20px 0;
  opacity: 0.5;
}

.brand-desc {
  font-size: 13px;
  line-height: 1.8;
  color: var(--text2);
  font-weight: 300;
}

.brand-badges {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.brand-badge {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 11px;
  color: var(--text2);
  font-family: var(--mono);
  letter-spacing: 0.5px;
}
.badge-icon {
  width: 28px; height: 28px;
  border: 1px solid var(--border-bright);
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px;
  flex-shrink: 0;
  color: var(--red);
}

.brand-version {
  font-family: var(--mono);
  font-size: 8px;
  color: var(--text3);
  letter-spacing: 2px;
}

/* RIGHT PANEL ‚Äî Form */
.right-panel {
  flex: 1;
  height: 100%;
  background: var(--dark2);
  border: 1px solid var(--border);
  border-radius: 0 12px 12px 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 50px 44px;
  position: relative;
}

.form-title {
  font-family: var(--display);
  font-size: 34px;
  letter-spacing: 3px;
  color: var(--text);
  margin-bottom: 6px;
}
.form-subtitle {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--text2);
  text-transform: uppercase;
  margin-bottom: 36px;
}

.input-group { margin-bottom: 16px; position: relative; }
.input-label {
  display: block;
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
  margin-bottom: 7px;
}

.input-field {
  width: 100%;
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: var(--sans);
  font-size: 14px;
  font-weight: 400;
  padding: 13px 16px 13px 42px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  letter-spacing: 0.3px;
}
.input-field:focus {
  border-color: rgba(227,6,19,0.5);
  box-shadow: 0 0 0 3px rgba(227,6,19,0.08);
}
.input-field::placeholder { color: var(--text3); }
.input-icon {
  position: absolute;
  bottom: 13px; left: 14px;
  font-size: 14px;
  color: var(--text3);
  pointer-events: none;
}

/* BIOMETRIC TOGGLE */
.bio-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  cursor: pointer;
  user-select: none;
}
.toggle-switch {
  width: 40px; height: 22px;
  background: var(--dark3);
  border: 1px solid var(--border-bright);
  border-radius: 11px;
  position: relative;
  transition: background 0.2s;
  flex-shrink: 0;
}
.toggle-switch.on { background: rgba(227,6,19,0.3); border-color: var(--red); }
.toggle-knob {
  position: absolute;
  top: 3px; left: 3px;
  width: 14px; height: 14px;
  background: var(--text2);
  border-radius: 50%;
  transition: transform 0.2s, background 0.2s;
}
.toggle-switch.on .toggle-knob { transform: translateX(18px); background: var(--red); }
.bio-label { font-family: var(--mono); font-size: 10px; color: var(--text2); letter-spacing: 1px; }

/* LOGIN BUTTON */
.btn-login {
  width: 100%;
  padding: 15px;
  background: var(--red);
  border: none;
  border-radius: 6px;
  color: white;
  font-family: var(--display);
  font-size: 18px;
  letter-spacing: 4px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.2s, transform 0.15s;
  margin-top: 4px;
}
.btn-login:hover {
  box-shadow: 0 4px 24px rgba(227,6,19,0.45);
  transform: translateY(-1px);
}
.btn-login:active { transform: translateY(0); }
.btn-login::before {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.4s;
}
.btn-login:hover::before { left: 100%; }
.btn-login:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.form-note {
  text-align: center;
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text3);
  letter-spacing: 1px;
  margin-top: 14px;
}

/* ERROR MESSAGE */
.error-msg {
  background: rgba(227,6,19,0.1);
  border: 1px solid rgba(227,6,19,0.3);
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 12px;
  color: #ff6b6b;
  font-family: var(--mono);
  letter-spacing: 0.3px;
  display: none;
  margin-bottom: 14px;
}
.error-msg.show { display: block; }

/* BIOMETRIC OVERLAY */
#bio-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.97);
  z-index: 9999;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(20px);
}
#bio-overlay.active { display: flex; }

.bio-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
}

.bio-title {
  font-family: var(--display);
  font-size: 28px;
  letter-spacing: 6px;
  color: var(--text2);
  margin-bottom: 40px;
  text-align: center;
}
.bio-title span { color: var(--red); }

.scanner-wrap {
  position: relative;
  width: 280px; height: 280px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.scan-ring {
  position: absolute;
  width: 100%; height: 100%;
  transform: rotate(-90deg);
}
.scan-ring-track {
  fill: none;
  stroke: rgba(255,255,255,0.05);
  stroke-width: 4;
}
.scan-ring-progress {
  fill: none;
  stroke: var(--red);
  stroke-width: 4;
  stroke-linecap: round;
  stroke-dasharray: 816;
  stroke-dashoffset: 816;
  filter: drop-shadow(0 0 6px var(--red));
  transition: stroke-dashoffset 0.08s linear;
}

/* Rotating dashes */
.scan-ring-dashes {
  position: absolute;
  width: 100%; height: 100%;
  animation: rotateSlow 8s linear infinite;
}
@keyframes rotateSlow { to{transform:rotate(360deg)} }

.video-frame {
  width: 220px; height: 220px;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid rgba(255,255,255,0.06);
  position: relative;
  z-index: 1;
}
#bio-video {
  width: 100%; height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}

.scan-overlay-lines {
  position: absolute;
  inset: 0; border-radius: 50%;
  overflow: hidden;
  pointer-events: none;
  z-index: 2;
}
.scan-beam {
  position: absolute;
  left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(227,6,19,0.6), transparent);
  animation: beamScan 2s ease-in-out infinite;
  top: 50%;
}
@keyframes beamScan { 0%{top:10%}50%{top:90%}100%{top:10%} }

.success-check {
  position: absolute;
  font-size: 80px;
  color: #00e676;
  filter: drop-shadow(0 0 20px #00e676);
  z-index: 10;
  display: none;
  animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes popIn { from{transform:scale(0.3);opacity:0}to{transform:scale(1);opacity:1} }

.bio-pct {
  font-family: var(--display);
  font-size: 52px;
  letter-spacing: 4px;
  color: var(--text);
  margin-top: 24px;
  min-height: 70px;
  text-align: center;
}
.bio-status {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 3px;
  color: var(--red);
  text-transform: uppercase;
  margin-top: 8px;
  text-align: center;
  min-height: 20px;
}

/* BREACH DISPLAY */
#breach-display {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 24px;
}
.breach-faces {
  display: flex;
  gap: 30px;
}
.breach-face {
  text-align: center;
}
.breach-face-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  margin-bottom: 10px;
  text-transform: uppercase;
}
.breach-face-label.ok { color: #00e676; }
.breach-face-label.fail { color: var(--red); }
.breach-img-wrap {
  position: relative;
  width: 150px; height: 150px;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid var(--border);
}
.breach-img-wrap img, .breach-img-wrap canvas {
  width: 100%; height: 100%;
  object-fit: cover;
}
.breach-mark {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 60px;
  font-weight: 900;
  background: rgba(0,0,0,0.4);
}

.breach-title {
  font-family: var(--display);
  font-size: 36px;
  letter-spacing: 4px;
  color: var(--red);
  text-align: center;
  text-shadow: 0 0 30px var(--red);
}
.breach-msg {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text2);
  text-align: center;
  letter-spacing: 1px;
  line-height: 1.8;
}

/* LOADING STATE */
.loading-bar {
  width: 100%;
  height: 2px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
  margin-top: 16px;
}
.loading-fill {
  height: 100%;
  background: var(--red);
  border-radius: 1px;
  animation: loadPulse 1.5s ease-in-out infinite;
  transform-origin: left;
}
@keyframes loadPulse { 0%,100%{transform:scaleX(0);margin-left:0} 50%{transform:scaleX(0.6);margin-left:20%} 100%{transform:scaleX(0);margin-left:100%} }

/* CLOCK */
#clock { font-family: var(--mono); font-size: 9px; color: var(--text3); }
</style>
</head>
<body>

<div class="bg-grid"></div>
<div class="bg-gradient"></div>
<div class="scan-line"></div>

<div class="corner corner-tl"></div>
<div class="corner corner-tr"></div>
<div class="corner corner-bl"></div>
<div class="corner corner-br"></div>

<!-- STATUS BAR -->
<div class="status-bar">
  <div class="status-dot"></div>
  <div class="status-text">SYSTEM ONLINE</div>
  <div class="status-text" style="color:var(--text3)">|</div>
  <div class="status-text">ALTEN PROCUREMENT PORTAL v2.0</div>
  <div class="status-right">
    <span id="clock"></span>
    &nbsp;&nbsp;|&nbsp;&nbsp;
    SECURE CHANNEL ACTIVE
  </div>
</div>

<!-- MAIN LOGIN CARD -->
<div class="login-wrap">

  <!-- LEFT PANEL -->
  <div class="left-panel">
    <div>
      <div class="brand-logo">
        <div class="brand-name">ALTEN</div>
        <div class="brand-sub">Procurement Intelligence</div>
      </div>
      <div class="brand-divider"></div>
      <div class="brand-desc">
        Production needs management platform for automotive manufacturing. Full supplier perimeter control with real-time tracking.
      </div>
    </div>

    <div class="brand-badges">
      <div class="brand-badge">
        <div class="badge-icon">‚¨°</div>
        <span>Multi-Supplier Perimeter Control</span>
      </div>
      <div class="brand-badge">
        <div class="badge-icon">‚óà</div>
        <span>MRD / Counter Mark / Phase View</span>
      </div>
      <div class="brand-badge">
        <div class="badge-icon">‚úà</div>
        <span>Auto Email Generation (Outlook)</span>
      </div>
      <div class="brand-badge">
        <div class="badge-icon">üîê</div>
        <span>Biometric Face Verification</span>
      </div>
      <div class="brand-badge">
        <div class="badge-icon">‚òÅ</div>
        <span>Firebase Real-time Sync</span>
      </div>
    </div>

    <div class="brand-version">BUILD 2026.02.19 ‚Äî ALL RIGHTS RESERVED ¬© ALTEN</div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div class="form-title">SECURE ACCESS</div>
    <div class="form-subtitle">Enter your credentials to access the portal</div>

    <div class="error-msg" id="errorMsg">‚ö† Invalid credentials. Please try again.</div>

    <div class="input-group">
      <label class="input-label">Email Address</label>
      <span class="input-icon">‚úâ</span>
      <input type="email" class="input-field" id="emailInput" placeholder="yourname@alten.com" autocomplete="email">
    </div>

    <div class="input-group">
      <label class="input-label">Password</label>
      <span class="input-icon">üîë</span>
      <input type="password" class="input-field" id="passInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>

    <div class="bio-toggle" id="bioToggle" onclick="toggleBio()">
      <div class="toggle-switch" id="toggleSwitch"></div>
      <span class="bio-label">ENABLE FACE VERIFICATION</span>
    </div>

    <button class="btn-login" id="loginBtn" onclick="handleLogin()">
      ENTER PORTAL ‚Üí
    </button>

    <div class="form-note">
      Access is restricted to authorized ALTEN personnel.<br>
      Unauthorized access attempts are logged and reported.
    </div>
  </div>
</div>

<!-- BIOMETRIC OVERLAY -->
<div id="bio-overlay">
  <div id="scan-zone">
    <div class="bio-container">
      <div class="bio-title">BIOMETRIC <span>VERIFICATION</span></div>

      <div class="scanner-wrap">
        <!-- Rotating dashes -->
        <svg class="scan-ring-dashes" viewBox="0 0 280 280">
          <circle cx="140" cy="140" r="130" fill="none" stroke="rgba(227,6,19,0.2)" stroke-width="1" stroke-dasharray="4 12"/>
        </svg>
        <!-- Progress ring -->
        <svg class="scan-ring" viewBox="0 0 280 280">
          <circle class="scan-ring-track" cx="140" cy="140" r="130"/>
          <circle class="scan-ring-progress" id="scanProgress" cx="140" cy="140" r="130"/>
        </svg>

        <div class="video-frame">
          <video id="bio-video" autoplay muted playsinline></video>
          <div class="scan-overlay-lines">
            <div class="scan-beam"></div>
          </div>
        </div>

        <div class="success-check" id="successCheck">‚úì</div>
      </div>

      <div class="bio-pct" id="bioPct">0%</div>
      <div class="bio-status" id="bioStatus">INITIALIZING SCAN‚Ä¶</div>
      <div class="loading-bar">
        <div class="loading-fill"></div>
      </div>
    </div>
  </div>

  <!-- BREACH DISPLAY (shown if face doesn't match) -->
  <div id="breach-display">
    <div class="breach-title">ACCESS DENIED</div>
    <div class="breach-faces">
      <div class="breach-face">
        <div class="breach-face-label ok">AUTHORIZED OWNER</div>
        <div class="breach-img-wrap">
          <img id="ownerImg" src="" alt="owner">
          <div class="breach-mark" style="color:#00e676">‚úì</div>
        </div>
      </div>
      <div class="breach-face">
        <div class="breach-face-label fail">UNAUTHORIZED USER</div>
        <div class="breach-img-wrap">
          <canvas id="intruderCanvas" width="150" height="150"></canvas>
          <div class="breach-mark" style="color:var(--red)">‚úï</div>
        </div>
      </div>
    </div>
    <div class="breach-msg">
      FACE DOES NOT MATCH THE REGISTERED ACCOUNT OWNER.<br>
      <span style="color:var(--red)">THIS INCIDENT HAS BEEN RECORDED.</span><br>
      AN ADMINISTRATOR WILL BE CONTACTED IMMEDIATELY.
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// ‚îÄ‚îÄ‚îÄ CONFIGURE YOUR FIREBASE PROJECT HERE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Clock
function updateClock(){
  const n=new Date();
  document.getElementById('clock').textContent=n.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
setInterval(updateClock,1000); updateClock();

// Biometric toggle
let bioEnabled = false;
window.toggleBio = function(){
  bioEnabled = !bioEnabled;
  document.getElementById('toggleSwitch').classList.toggle('on', bioEnabled);
};

// Face API models - load eagerly
let modelsReady = false;
let modelsPromise = (async()=>{
  try{
    const BASE = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(BASE),
      faceapi.nets.faceLandmark68Net.loadFromUri(BASE),
      faceapi.nets.faceRecognitionNet.loadFromUri(BASE),
      faceapi.nets.ssdMobilenetv1.loadFromUri(BASE),
    ]);
    modelsReady = true;
  }catch(e){ console.warn('Face API models failed to load ‚Äî biometric disabled', e); }
})();

// Error display
function showError(msg){
  const el = document.getElementById('errorMsg');
  el.textContent = '‚ö† '+msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 4000);
}

// MAIN LOGIN
window.handleLogin = async function(){
  const email = document.getElementById('emailInput').value.trim().toLowerCase();
  const pass = document.getElementById('passInput').value;

  if(!email || !pass){ showError('Please fill in all fields.'); return; }

  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  btn.textContent = 'VERIFYING‚Ä¶';

  try {
    if(bioEnabled){
      const verified = await runBiometric(email);
      if(!verified){ btn.disabled=false; btn.textContent='ENTER PORTAL ‚Üí'; return; }
    }

    // Firebase sign in
    await signInWithEmailAndPassword(auth, email, pass);

    // Route by role
    if(email === 'mohamed@alten.com'){
      window.location.href = 'admin.html';
    } else {
      window.location.href = 'procurement.html';
    }

  } catch(err) {
    console.error(err);
    showError(err.code === 'auth/wrong-password' ? 'Invalid password.' :
              err.code === 'auth/user-not-found' ? 'No account found for this email.' :
              err.code === 'auth/network-request-failed' ? 'Network error ‚Äî check your connection.' :
              'Login failed: ' + err.message);
    btn.disabled=false;
    btn.textContent='ENTER PORTAL ‚Üí';
  }
};

// Allow Enter key
document.addEventListener('keydown', e=>{
  if(e.key==='Enter') window.handleLogin();
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BIOMETRIC SCAN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runBiometric(email){
  const overlay = document.getElementById('bio-overlay');
  const video = document.getElementById('bio-video');
  const progressEl = document.getElementById('scanProgress');
  const pctEl = document.getElementById('bioPct');
  const statusEl = document.getElementById('bioStatus');
  const successEl = document.getElementById('successCheck');
  const circumference = 2 * Math.PI * 130; // ‚âà 816.8

  // Show overlay
  overlay.classList.add('active');
  statusEl.textContent = 'LOADING MODELS‚Ä¶';

  // Wait for models
  await modelsPromise;
  if(!modelsReady){
    overlay.classList.remove('active');
    showError('Face API unavailable ‚Äî log in without biometrics.');
    return true; // allow login
  }

  // Try to load reference image
  const [username] = email.split('@');
  const imagePath = `./images/${username}.jpg`;
  let refDescriptor = null;

  try {
    const refImg = await faceapi.fetchImage(imagePath);
    const refResult = await faceapi
      .detectSingleFace(refImg, new faceapi.SsdMobilenetv1Options())
      .withFaceLandmarks()
      .withFaceDescriptor();
    if(refResult) refDescriptor = refResult;
    statusEl.textContent = 'REFERENCE LOADED ‚Äî STARTING CAMERA‚Ä¶';
  } catch(e) {
    console.warn('No reference image found for', email, '‚Äî skipping biometric.');
    overlay.classList.remove('active');
    return true;
  }

  // Start camera
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user', width:320, height:320 } });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
    statusEl.textContent = 'SCANNING ‚Äî HOLD STILL‚Ä¶';
  } catch(e) {
    overlay.classList.remove('active');
    showError('Camera access denied ‚Äî cannot verify identity.');
    return false;
  }

  return new Promise(resolve => {
    let progress = 0;
    let matched = false;

    const interval = setInterval(async () => {
      const live = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({inputSize:224,scoreThreshold:0.4}))
        .withFaceLandmarks()
        .withFaceDescriptor();

      if(live && refDescriptor){
        const matcher = new faceapi.FaceMatcher(refDescriptor, 0.55);
        const result = matcher.findBestMatch(live.descriptor);
        if(result.label !== 'unknown') matched = true;
      }

      progress += 2;
      const pct = Math.min(progress, 100);
      const offset = circumference - (pct / 100 * circumference);
      progressEl.style.strokeDashoffset = offset;
      pctEl.textContent = pct + '%';

      if(progress >= 100){
        clearInterval(interval);
        stream.getTracks().forEach(t=>t.stop());

        if(matched){
          successEl.style.display = 'block';
          statusEl.textContent = 'IDENTITY CONFIRMED ‚úì';
          pctEl.style.color = '#00e676';
          setTimeout(()=>{
            overlay.classList.remove('active');
            successEl.style.display = 'none';
            progressEl.style.strokeDashoffset = circumference;
            pctEl.textContent = '0%';
            pctEl.style.color = '';
            progress = 0;
            resolve(true);
          }, 1500);
        } else {
          // BREACH
          document.getElementById('scan-zone').style.display = 'none';
          document.getElementById('breach-display').style.display = 'flex';

          document.getElementById('ownerImg').src = imagePath;
          const ctx = document.getElementById('intruderCanvas').getContext('2d');
          ctx.drawImage(video, 0, 0, 150, 150);

          setTimeout(()=>{ window.location.reload(); }, 9000);
          resolve(false);
        }
      }
    }, 50);
  });
}

</script>
</body>
</html>
