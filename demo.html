<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mercedes-Benz Plant Operations ‚Äî DEMO</title>
  <script src="https://meet.jit.si/external_api.js"></script>
  <style>
    body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; overflow-x: hidden; }
    .sidebar { width: 260px; border-right: 1px solid #333; height: 100vh; padding: 25px; position: fixed; background: #050505; z-index: 10005; overflow-y: auto; }
    .main { margin-left: 285px; padding: 40px; flex: 1; transition: filter 0.5s ease; }
    #mainPage, #adminPanel, #interventionPage, #missionPage, #historyPage, #kpiTrackerPage, #personnelPage { display: none; background: #111; border-left: 4px solid #e30613; padding: 25px; margin-bottom: 30px; }
    #mainPage { display: block; }
    .card { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
    .checklist-item { display: block; margin: 10px 0; font-size: 0.9rem; }
    input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { text-align: left; padding: 15px; color: #666; border-bottom: 2px solid #222; font-size: 0.8rem; }
    td { padding: 15px; border-bottom: 1px solid #1a1a1a; }
    .status-working { color: #00ff00; background: rgba(0, 255, 0, 0.1); padding: 4px 10px; border-radius: 4px; font-weight: bold; }
    .status-breakdown { color: #ff3333; background: rgba(255, 51, 51, 0.1); padding: 4px 10px; border-radius: 4px; font-weight: bold; }
    button { cursor: pointer; padding: 10px 20px; background: #e30613; color: white; border: none; font-weight: bold; transition: 0.3s; }
    button:hover { background: #fff; color: #000; }
    .btn-nav { width: 100%; margin-top: 10px; text-align: left; background: transparent; color: #aaa; border: 1px solid #222; }
    .tech-select { background: #222; color: #fff; border: 1px solid #444; padding: 5px; font-size: 0.7rem; width: auto; }
    .kpi-alert { background: #ff3333; color: #fff; padding: 5px; font-weight: bold; border-radius: 4px; display: inline-block; margin-top: 5px; border: 1px solid #fff; }
    .step-row { display: flex; align-items: center; margin-bottom: 10px; }
    .step-bubble { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; margin-right: 15px; font-weight: bold; font-size: 14px; }
    .step-green { background: #00ff00; color: #000; }
    .step-red { background: #ff3333; color: #fff; }
    .step-orange { background: #ffa500; color: #000; }
    .edited-tag { color: #ffcc00; font-weight: bold; font-size: 0.7rem; border: 1px solid #ffcc00; padding: 2px 5px; border-radius: 3px; margin-left: 10px; }

    /* DEMO MENTOR */
    #demoMentor { position: fixed; bottom: 40px; right: 40px; width: 380px; background: rgba(10, 10, 10, 0.98); border: 2px solid #e30613; border-radius: 15px; padding: 25px; z-index: 30005; display: none; box-shadow: 0 0 50px rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
    .mentor-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .mentor-robot { width: 50px; height: 50px; background: #e30613; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; }
    .mentor-text { font-size: 1rem; line-height: 1.5; color: #fff; }
    .mentor-btn { margin-top: 20px; background: #e30613; color: #fff; border: none; padding: 12px 20px; font-weight: bold; cursor: pointer; width: 100%; border-radius: 5px; }

    .blur-bg { filter: blur(10px) grayscale(90%); pointer-events: none; transition: 0.4s; }
    .highlight-focus { outline: 4px solid #e30613 !important; outline-offset: 4px; z-index: 30001 !important; position: relative !important; filter: none !important; pointer-events: all !important; background: #111 !important; box-shadow: 0 0 40px rgba(227, 6, 19, 0.8) !important; }
    .request-glow { animation: goldPulsar 1.5s infinite alternate; }
    @keyframes goldPulsar { from { box-shadow: 0 0 5px #ffcc00; border-color: #ffcc00; } to { box-shadow: 0 0 25px #ffcc00; border-color: #fff; } }
  </style>
</head>
<body onclick="window.handleFirstInteraction()">
  <audio id="effectAudio" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

  <!-- DEMO Mentor -->
  <div id="demoMentor">
    <div class="mentor-header">
      <div class="mentor-robot">ü§ñ</div>
      <div>
        <b style="color:#e30613; display:block; font-size: 1.2rem;">SYSTEM OVERSEER</b>
        <small style="color:#666;">Onboarding Unit v4.0</small>
      </div>
    </div>
    <div id="mentorContent" class="mentor-text"></div>
    <button id="mentorNext" class="mentor-btn">INITIATE NEXT PHASE</button>
  </div>

  <!-- ACCESS DENIED -->
  <div id="accessDeniedModal">
    <div class="security-shield">
      <div class="security-scan-line"></div>
      <h1 style="font-size: 4rem; color: #e30613; margin: 0; font-family: monospace;">[!]</h1>
      <h2 style="letter-spacing: 8px; color: #fff;">SECURITY VIOLATION</h2>
      <p id="deniedText" style="color: #666; font-size: 0.8rem;">BIOMETRIC SIGNATURE NOT RECOGNIZED.<br>ENCRYPTION LEVEL 102 ACTIVE.</p>
      <button onclick="document.getElementById('accessDeniedModal').style.display='none'" style="margin-top:30px; background:transparent; border: 1px solid #e30613; color: #e30613; padding: 10px 40px;">DISMISS</button>
    </div>
  </div>

  <!-- MACHINE DETAIL POPUP -->
  <div id="machineDetailPopup">
    <div id="machineDetailContent"></div>
    <button onclick="document.getElementById('machineDetailPopup').style.display='none'" style="width:100%; margin-top:15px; background:#444;">CLOSE</button>
  </div>

  <!-- CALL POPUP -->
  <div id="callPopup">
    <h2 style="font-size: 1.2rem; margin: 0;">DIRECTOR EMERGENCY LINE</h2>
    <p id="callMachineName" style="color: #e30613; font-weight: bold; margin: 5px 0;"></p>
    <div id="videoContainer"></div>
    <div id="mohamedConsole" class="director-console" style="display:none;">
      <button onclick="window.triggerRemoteAudio()" style="background:#ffcc00; color:#000; font-size: 12px; width: 100%;">üîî SEND ALERT SOUND</button>
    </div>
    <button id="hangUpBtn" style="background:#ff3333; border-radius:50%; width:50px; height:50px; border:none; color:white; font-size:1.2rem; margin-top:15px;" onclick="window.endEmergencyCall()">üìû</button>
    <div style="margin-top:10px; font-size:11px; border-top:1px solid #333; padding-top:10px;">
      <span id="statusDot" class="status-dot"></span> <span id="webrtcState">DIRECT LINE ENCRYPTED</span>
    </div>
  </div>

  <div class="sidebar" id="mainSidebar">
    <h2 style="color: #e30613;">MERCEDES</h2>
    <button id="audioActivator" onclick="window.activateAudioSystem()">STEP 1: ENABLE MIC</button>
    <p id="userDisplay" style="font-size: 11px; color: #666;"></p>

    <div id="reqPermissionBox" style="display:none; margin-bottom: 10px;">
      <button onclick="window.requestAccess()" style="background:#444; font-size: 10px; width: 100%; padding: 5px;">PROMPT MOHAMED FOR ACCESS</button>
    </div>

    <hr style="border:0; border-top:1px solid #333;">
    <button class="btn-nav" id="nav_mainPage" onclick="window.showPage('mainPage')">üè† Dashboard</button>
    <button class="btn-nav" id="nav_interventionPage" onclick="window.showPage('interventionPage')">üìù Interventions</button>
    <button class="btn-nav" id="nav_missionPage" onclick="window.showPage('missionPage')">üõ†Ô∏è Missions</button>
    <button class="btn-nav" id="nav_historyPage" onclick="window.showPage('historyPage')">üìö History</button>
    <button class="btn-nav" id="nav_kpiTrackerPage" onclick="window.showPage('kpiTrackerPage')">üìä KPI Command</button>
    <button class="btn-nav" id="nav_personnelPage" onclick="window.showPage('personnelPage')" style="border: 1px solid #e30613; color: #e30613;">üë• Personnel</button>
    <button onclick="window.logout()" style="width: 100%; margin-top: 20px;">SIGN OUT</button>
  </div>

  <div class="main" id="contentMain">
    <div id="personnelPage">
      <h1 style="letter-spacing: 5px;">PERSONNEL & ACCESS CONTROL</h1>
      <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
        <div>
          <div class="card" id="securityMatrixCard" style="border-top: 4px solid #e30613;">
            <h3 style="margin-top:0;">SECURITY & ACCESS MATRIX</h3>
            <p style="font-size: 12px; color: #666;">Select a technician to manage permissions and initiate calls.</p>
            <div id="userAccessList"></div>
          </div>
        </div>
        <div>
          <div class="card" style="border: 2px solid #ffcc00;">
            <h3 style="color:#ffcc00; margin-top:0;">ACTIVE BREAKDOWNS (CALLS)</h3>
            <div id="breakdownCallList"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="adminPanel">
      <h3>DIRECTOR CONTROL</h3>
      <div id="adminApprovalList"></div>
    </div>

    <div id="mainPage">
      <h1>Plant Asset Library</h1>
      <table id="assetTableElement">
        <thead><tr><th>ID</th><th>NAME</th><th>SECTION</th><th>STATUS</th><th>ACTIONS</th></tr></thead>
        <tbody id="assetTable">
          <tr id="demoRow1">
            <td>M-001</td>
            <td>Robotic Axis 4</td>
            <td>ROBOTIC</td>
            <td><span id="demoStatus1" class="status-working">WORKING</span></td>
            <td>---</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="interventionPage">
      <h1>Step 1: Request Intervention</h1>
      <div class="card" id="interventionCard">
        <select id="reqMachine">
          <option value="">Select Machine...</option>
          <option value="M-001">Robotic Axis 4</option>
        </select>
        <textarea id="reqIssue" placeholder="Describe the failure..."></textarea>
        <button id="submitReqBtn">SUBMIT TO DIRECTOR</button>
      </div>
    </div>

    <div id="missionPage">
      <h1>Step 3: Technical Missions</h1>
      <div id="missionList">
        <div id="demoMissionCard" class="card" style="display:none; border-left: 4px solid #ffa500;">
          <h3>MISSION: M-001 Repair</h3>
          <div id="demoPrePhoto" style="display:flex; gap:10px; margin-bottom:15px;"></div>
          <div id="demoChecklist">
            <label class="checklist-item"><input type="checkbox" id="check1"> Isolate Power Supply</label>
            <label class="checklist-item"><input type="checkbox" id="check2"> Replace Hydraulic Seal</label>
            <label class="checklist-item"><input type="checkbox" id="check3"> Pressure Test System</label>
          </div>
          <div id="demoPostPhoto" style="display:flex; gap:10px; margin-top:15px;"></div>
          <button id="demoSubmitMission" style="margin-top:15px; width:100%;">SUBMIT FINAL REPORT</button>
        </div>
      </div>
    </div>

    <div id="historyPage">
      <h1>Maintenance Archive</h1>
      <div id="historyList"></div>
    </div>

    <div id="kpiTrackerPage">
      <h1>STRATEGIC MISSION CONTROL</h1>
      <div class="kpi-container">
        <div class="kpi-hero-card">
          <span class="kpi-sub-label">Global Plant Efficiency</span>
          <span id="globalKpiVal" class="kpi-main-val">94%</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, onSnapshot, doc, setDoc, updateDoc, addDoc, query, where, deleteDoc, getDocs, serverTimestamp, getDoc, arrayUnion, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const DIRECTOR = "mohamed.aouladzerouali@jobson.com";
    let micReady = false, machineCache = {}, jitsiApi = null, userPermissions = {};

    window.activateAudioSystem = async () => { micReady = true; document.getElementById('audioActivator').style.background = "#00ff00"; document.getElementById('audioActivator').innerText = "‚úÖ SYSTEM READY"; };
    window.handleFirstInteraction = () => {};

    function speakNative(text, callback) { const msg = new SpeechSynthesisUtterance(text); const voices = window.speechSynthesis.getVoices(); const preferredVoice = voices.find(v => (v.name.includes("Google") || v.name.includes("Natural")) && v.lang.startsWith("en-US")) || voices[0]; msg.voice = preferredVoice; msg.rate = 1.0; msg.pitch = 1.0; if (callback) msg.onend = callback; window.speechSynthesis.speak(msg); }

    window.clearFocus = () => { try { document.querySelectorAll('.highlight-focus').forEach(el => el.classList.remove('highlight-focus')); } catch(e){} const cm = document.getElementById('contentMain'); const sb = document.getElementById('mainSidebar'); if (cm) cm.classList.remove('blur-bg'); if (sb) sb.classList.remove('blur-bg'); };
    function setFocus(elId) { window.clearFocus(); const targetEl = document.getElementById(elId); const sidebar = document.getElementById('mainSidebar'); const mainContent = document.getElementById('contentMain'); if (sidebar && sidebar.contains(targetEl)) { if (mainContent) mainContent.classList.add('blur-bg'); } else if (mainContent && mainContent.contains(targetEl)) { if (sidebar) sidebar.classList.add('blur-bg'); } if (targetEl) { targetEl.classList.add('highlight-focus'); try { targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e){} } }

    window.showPage = (id) => { ['mainPage', 'adminPanel', 'interventionPage', 'missionPage', 'historyPage', 'kpiTrackerPage', 'personnelPage'].forEach(p => { const el = document.getElementById(p); if(el) el.style.display = (p === id ? 'block' : 'none'); }); };

    // ========================= DEMO MODULE =========================
    let demoStep = 0; window.demoModeActive = false;
    window.startDemoSequence = (name) => { window.demoModeActive = true; document.getElementById('demoMentor').style.display = 'block'; window.nextDemoStep(name); };
    window.nextDemoStep = (name) => {
      const mentor = document.getElementById('mentorContent'); const btn = document.getElementById('mentorNext'); const email = auth.currentUser?.email?.toLowerCase();
      const steps = [
        { text: `Welcome, Specialist ${name}. I am the Plant Overseer. I will guide you through our core operational protocols. Let's start with your Dashboard.`, action: () => { window.showPage('mainPage'); setFocus('nav_mainPage'); } },
        { text: "Observe the Asset Library. I am now simulating a sensor failure in Robotic Axis 4. Notice the status indicator transitioning to critical breakdown status.", action: () => { setFocus('assetTableElement'); setTimeout(() => { const status = document.getElementById('demoStatus1'); status.innerText = "BREAKDOWN"; status.className = "status-breakdown"; }, 5000); } },
        { text: "Security is vital. Attempting unauthorized access to personnel records triggers an immediate biometric lockout. Observe.", action: () => { setFocus('nav_personnelPage'); btn.style.display = 'none'; setTimeout(() => { document.getElementById('accessDeniedModal').style.display = 'flex'; speakNative("Warning. Access Denied. Biometric signature mismatch."); btn.style.display = 'block'; }, 6000); } },
        { text: "Now, let's report the failure. Navigate to the Interventions section.", action: () => { document.getElementById('accessDeniedModal').style.display = 'none'; window.showPage('interventionPage'); setFocus('nav_interventionPage'); } },
        { text: "Select Robotic Axis 4 and describe the pressure drop. Then, submit your report to the Director.", action: () => { setFocus('interventionCard'); setTimeout(() => { document.getElementById('reqMachine').selectedIndex = 1; setTimeout(() => { document.getElementById('reqIssue').value = "[DEMO] Hydraulic Pressure Drop detected."; }, 1500); }, 1000); } },
        { text: "The Director is initiating a brief via the encrypted line to review your request.", action: () => { window.clearFocus(); setTimeout(() => window.simulateRobotCall(name), 2000); } },
        { text: "Now that the Director has approved your request, you must go and fix the problem. First, take a picture of the panne and upload it to your mission file.", action: () => { window.showPage('missionPage'); setFocus('demoMissionCard'); document.getElementById('demoMissionCard').style.display = 'block'; setTimeout(() => { document.getElementById('demoPrePhoto').innerHTML = "<div style='width:60px; height:60px; background:#333; border:1px solid #e30613; display:flex; align-items:center; justify-content:center; font-size:20px;'>üì∏</div><small style='color:#666;'>panne_initial.jpg</small>"; }, 4000); } },
        { text: "Excellent. After finishing the repair, you must tick each maintenance step you have completed to verify the fix.", action: () => { setFocus('demoChecklist'); setTimeout(() => { document.getElementById('check1').checked = true; setTimeout(() => { document.getElementById('check2').checked = true; setTimeout(() => { document.getElementById('check3').checked = true; }, 1000); }, 1000); }, 3000); } },
        { text: "Finally, upload the image of the problem fixed and submit your report. The Director will review and approve it shortly.", action: () => { setFocus('demoSubmitMission'); setTimeout(() => { document.getElementById('demoPostPhoto').innerHTML = "<div style='width:60px; height:60px; background:#333; border:1px solid #00ff00; display:flex; align-items:center; justify-content:center; font-size:20px;'>‚úÖ</div><small style='color:#666;'>fixed_final.jpg</small>"; }, 3000); } },
        { text: "If there are any issues with your report, the Director will contact you directly. Onboarding complete. Welcome to Mercedes-Benz Operations.", action: () => {
            window.clearFocus(); window.demoModeActive = false; document.getElementById('demoMentor').style.display = 'none';
            if(email) localStorage.setItem(`demoDone_${email}`, 'true');
            // üëâ Redirect to the real system once demo ends
            window.location.href = 'maintenance.html';
          } }
      ];
      if (demoStep < steps.length) { const current = steps[demoStep]; mentor.innerHTML = current.text; speakNative(current.text); current.action(); demoStep++; }
    };

    window.simulateRobotCall = (name) => {
      const popup = document.getElementById('callPopup');
      popup.style.display = 'block';
      document.getElementById('callMachineName').innerText = "DIRECTOR BRIEFING";
      document.getElementById('videoContainer').innerHTML = "<div style='height:100%; display:flex; align-items:center; justify-content:center; font-size:50px; background:#000;'>üëî</div>";
      speakNative(`Specialist ${name}. I have reviewed the pressure drop. I will approve your request. Proceed with the maintenance mission immediately.`, () => {
        setTimeout(() => { popup.style.display = 'none'; window.nextDemoStep(); }, 3000);
      });
    };

    document.getElementById('mentorNext').onclick = () => window.nextDemoStep();

    // AUTH: start demo automatically when page is loaded and user is authenticated
    onAuthStateChanged(auth, async user => {
      if (!user) { window.location.href = "login.html"; return; }
      const email = user.email.toLowerCase();
      document.getElementById('userDisplay').innerText = `ACCESS: ${email}`;

      window.speechSynthesis.onvoiceschanged = () => { setTimeout(() => { if(!window.demoModeActive) window.startDemoSequence(user.displayName || email.split('@')[0]); }, 1000); };
      setTimeout(() => { if(!window.demoModeActive) window.startDemoSequence(user.displayName || email.split('@')[0]); }, 1500);
    });

    window.logout = () => signOut(auth);
  </script>
</body>
</html>
